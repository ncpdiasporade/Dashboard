<!DOCTYPE html>
<html>
<head>
    <title>Battery Storage Controller Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- amCharts 4 Core -->
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <!-- amCharts 4 Charts -->
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <!-- amCharts 4 Animated Theme -->
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #0d191f;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        #dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin: auto;
        }
        .chart-card {
            background-color: #1f2c34;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            padding: 19px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
      
        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
      
        .chart-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            color: #e0e0e0;
            text-align: center;
            font-weight: 500;
        }
        .chart-div {
            flex-grow: 1;
            width: 100%;
            height: 100%;
        }
        .card-one {
            grid-column: span 2;
            height: 315px;
        }
        .card-large {
            grid-column: span 3;
            height: 315px;
        }
        .card-medium {
            grid-column: span 2;
            height: 315px;
        }
        .card-small {
            grid-column: span 1;
            height: 315px;
        }
        /* Enhanced cards for important metrics */
        .enhanced-card {
            grid-column: span 2;
            height: 400px;
            border: 2px solid #00bfff;
            background: linear-gradient(135deg, #2a3b4d 0%, #1e2a38 100%);
        }
        .enhanced-card h3 {
            color: #00bfff;
            font-weight: 600;
            font-size: 1.2rem;
        }
        /* Status indicators */
        .status-container {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }
        .status-item {
            text-align: center;
        }
        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .status-label {
            font-size: 0.85rem;
            color: #aaa;
        }
        .status-charge { color: #56CCF2; }
        .status-discharge { color: #27AE60; }
        /* Adjust for wide charts */
        .wide-chart {
            grid-column: span 3;
        }
        /* Energy flow visualization */
        .energy-flow-container {
            display: flex;
            height: 100%;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .energy-flow {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .flow-row {
            display: flex;
            width: 100%;
            justify-content: space-between;
            margin: 10px 0;
        }
        .flow-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        .flow-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 5px 0;
        }
        .flow-label {
            font-size: 0.8rem;
            color: #aaa;
        }
        .flow-arrow {
            font-size: 1.5rem;
            margin: 0 10px;
            color: #00bfff;
        }
        .battery-icon {
            width: 60px;
            height: 120px;
            border: 2px solid #00bfff;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
            margin: 10px 0;
        }
        .battery-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #00bfff, #0066cc);
            transition: height 0.5s ease;
        }
        .battery-cap {
            width: 20px;
            height: 5px;
            background-color: #00bfff;
            border-radius: 2px;
            margin: 0 auto;
        }
      
        /* Alert styling */
        .alert-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }
      
        .alert-warning {
            background-color: #FFC107;
            box-shadow: 0 0 8px #FFC107;
        }
      
        .alert-critical {
            background-color: #F44336;
            box-shadow: 0 0 8px #F44336;
            animation: pulse 1.5s infinite;
        }
      
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
      
        /* Dashboard header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a3b44;
        }
      
        .dashboard-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #e0e0e0;
        }
      
        .system-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }
      
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
      
        .status-normal {
            background-color: #4CAF50;
            color: white;
        }
      
        .status-warning {
            background-color: #FFC107;
            color: #333;
        }
      
        .status-critical {
            background-color: #F44336;
            color: white;
        }
      
        .last-updated {
            font-size: 0.85rem;
            color: #aaa;
        }
      
        /* Mode Indicator */
        .mode-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
        }
        .mode-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
        }
        .mode-icon.charging {
            color: #00bfff;
            background: rgba(0, 191, 255, 0.1);
        }
        .mode-icon.discharging {
            color: #ff9800;
            background: rgba(255, 152, 0, 0.1);
        }
        .mode-icon.idle {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        .mode-text {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .power-flow {
            font-size: 1.2rem;
            color: #aaa;
        }
      
        .power-negative {
            color: #00bfff;
        }
      
        .power-positive {
            color: #ff9800;
        }
      
        .power-zero {
            color: #4CAF50;
        }
      
        /* Real-time power flow */
        .power-flow-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
      
        .power-flow-visual {
            display: flex;
            align-items: center;
            gap: 20px;
        }
      
        .flow-direction {
            font-size: 2rem;
            color: #00bfff;
        }
      
        .flow-amount {
            font-size: 2.5rem;
            font-weight: bold;
        }
      
        /* Enhanced power flow visualization */
        .power-flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }
      
        .power-source {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
      
        .power-source-icon {
            font-size: 2.5rem;
            padding: 15px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
        }
      
        .power-source-label {
            font-size: 0.9rem;
            color: #aaa;
        }
      
        .power-flow-arrow {
            font-size: 2.5rem;
            color: #00bfff;
            position: relative;
        }
      
        .power-flow-arrow::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            width: 60px;
            height: 2px;
            background: #00bfff;
            transform: translateY(-50%);
        }
      
        .power-flow-arrow.charging::after {
            background: #00bfff;
        }
      
        .power-flow-arrow.discharging::after {
            background: #ff9800;
        }
      
        .power-flow-arrow.idle::after {
            background: #4CAF50;
        }
      
        .power-flow-arrow.charging {
            color: #00bfff;
        }
      
        .power-flow-arrow.discharging {
            color: #ff9800;
        }
      
        .power-flow-arrow.idle {
            color: #4CAF50;
        }
      
        .power-flow-value {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 10px;
        }
      
        .power-flow-label {
            font-size: 1rem;
            color: #aaa;
            margin-top: 5px;
        }
        /* Traffic Light */
        .traffic-light {
            background-color: #333;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
            margin: 0 auto;
            height: 140px;
            justify-content: space-between;
        }
        .light {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #555;
            transition: all 0.3s;
        }
        .light.active {
            box-shadow: 0 0 20px currentColor;
        }
        .red.active {
            background-color: #F44336;
        }
        .green.active {
            background-color: #4CAF50;
        }
        /* Thermometer and Voltmeter styles */
        .thermometer-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
        }
        .thermometer {
            position: relative;
            width: 30px;
            height: 200px;
            background: #444;
            border-radius: 15px;
            overflow: hidden;
        }
        .thermometer-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #F44336, #FFC107);
            transition: height 0.5s ease;
        }
        .thermometer-label {
            text-align: center;
            margin-top: 10px;
            font-size: 1rem;
        }
        .voltmeter-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
        }
        .voltmeter {
            position: relative;
            width: 150px;
            height: 75px;
            background: #444;
            border-radius: 75px 75px 0 0;
            overflow: hidden;
            transform: rotate(180deg);
        }
        .voltmeter-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 60px;
            background: #ff9800;
            transform-origin: bottom center;
            transition: transform 0.5s ease;
        }
        .voltmeter-label {
            text-align: center;
            margin-top: 10px;
            font-size: 1rem;
            transform: rotate(180deg);
        }
        .soc-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="dashboard-title">Battery Storage Controller Dashboard</div>
        <div class="system-status">
            <div class="status-badge status-normal" id="systemStatus">System Normal</div>
            <div class="last-updated">Last updated: <span id="lastUpdatedTime">Just now</span></div>
        </div>
    </div>
    <div id="dashboard-container">
         <!--
        <div class="chart-card card-medium">
            <h3>Battery Operating Mode</h3>
            <div class="mode-indicator" id="modeIndicator">
              
            </div>
        </div>
      
        <div class="chart-card card-one">
            <h3>Real-time Power Flow</h3>
            <div class="power-flow-container">
                <div class="power-flow-diagram" id="powerFlowDiagram">
                  
                </div>
            </div>
        </div>
        -->
        <div class="chart-card card-small">
            <h3>Battery Operating Mode</h3>
            <div class="mode-indicator" id="modeIndicator">
              
            </div>
        </div>
        <!-- Row 2: Combined SOC & Available Energy, SoH, SS -->
        <!-- Combined Available Energy with SOC -->
        <div class="chart-card card-medium">
            <div class="alert-indicator" id="socAlert"></div>
            <h3>Available Energy (kWh) & SOC</h3>
            <div class="energy-flow-container">
                <div class="energy-flow">
                    <div class="flow-row">
                        <div class="flow-item">
                            <div class="flow-label">Available Charge</div>
                            <div class="flow-value" id="chargeEnergyValue"></div>
                        </div>
                    </div>
                    <div class="battery-icon">
                        <div class="battery-fill" id="batteryFill"></div>
                        <div class="soc-label" id="socLabel"></div>
                    </div>
                    <div class="battery-cap"></div>
                    <div class="flow-row">
                        <div class="flow-item">
                            <div class="flow-label">Available Discharge</div>
                            <div class="flow-value" id="dischargeEnergyValue"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Health Gauge -->
        <div class="chart-card card-medium">
            <div class="alert-indicator" id="healthAlert"></div>
            <h3>Battery State of Health</h3>
            <div id="healthChart" class="chart-div"></div>
        </div>
        <!-- System Status -->
        <div class="chart-card card-small">
            <div class="alert-indicator" id="errorAlert"></div>
            <h3>System Status</h3>
            <div id="stateErrorChart" class="chart-div"></div>
        </div>
        <!-- Row 4: Max Power -->
        <!-- Max Charge/Discharge Power -->
        <div class="chart-card card-large">
            <h3>Max Power (kW)</h3>
            <div id="powerChart" class="chart-div"></div>
        </div>
        <!-- Row 3: Ac Power (min/max), Ac Power (kW/kVAR) -->
        <!-- AC Power Gauge -->
        <div class="chart-card card-medium">
            <h3>AC Power</h3>
            <div id="acPowerGaugeChart" class="chart-div"></div>
        </div>
        <!-- AC Power -->
        <div class="chart-card card-large">
            <h3>AC Power (kW/kVAR)</h3>
            <div id="acPowerChart" class="chart-div"></div>
        </div>
        <!-- Row 5: Battery Temperature, Temperature Trends -->
         <!-- Battery Temperature Thermometer -->
        <div class="chart-card card-medium">
            <div class="alert-indicator" id="tempAlert"></div>
            <h3>Battery Temperature (¬∞C)</h3>
            <div class="thermometer-container">
                <div>
                    <div class="thermometer">
                        <div class="thermometer-fill" id="tempMinFill"></div>
                    </div>
                    <div class="thermometer-label" id="tempMinLabel"></div>
                </div>
                <div>
                    <div class="thermometer">
                        <div class="thermometer-fill" id="tempMaxFill"></div>
                    </div>
                    <div class="thermometer-label" id="tempMaxLabel"></div>
                </div>
            </div>
        </div>
        <!-- Temperature Trends -->
        <div class="chart-card card-large">
            <h3>Battery Temperature Trends</h3>
            <div id="temperatureTrendChart" class="chart-div"></div>
        </div>
        <!-- Row 6: Battery Voltage, Battery Voltage Trends -->
         <!-- Battery Voltage Voltmeter -->
        <div class="chart-card card-medium">
            <div class="alert-indicator" id="voltageAlert"></div>
            <h3>Battery Voltage (V)</h3>
            <div class="voltmeter-container">
                <div>
                    <div class="voltmeter">
                        <div class="voltmeter-needle" id="voltageMinNeedle"></div>
                    </div>
                    <div class="voltmeter-label" id="voltageMinLabel"></div>
                </div>
                <div>
                    <div class="voltmeter">
                        <div class="voltmeter-needle" id="voltageMaxNeedle"></div>
                    </div>
                    <div class="voltmeter-label" id="voltageMaxLabel"></div>
                </div>
            </div>
        </div>
        <!-- Voltage Trends -->
        <div class="chart-card card-large">
            <h3>Battery Voltage Trends</h3>
            <div id="voltageTrendChart" class="chart-div"></div>
        </div>
    </div>
    <script>
        am4core.ready(function() {
            // Apply amCharts animated theme
            am4core.useTheme(am4themes_animated);
            // Global settings for dark theme
            am4core.options.autoSetClassName = true;
            // --- Helper function for configuring axes ---
            function configureAxis(axis) {
                axis.renderer.line.stroke = am4core.color("#888");
                axis.renderer.ticks.template.stroke = am4core.color("#888");
                axis.renderer.labels.template.fill = am4core.color("#e0e0e0");
                axis.renderer.grid.template.stroke = am4core.color("#888");
                axis.renderer.grid.template.strokeOpacity = 0.3;
            }
          
            // --- Update last updated time ---
            function updateLastUpdatedTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.getElementById('lastUpdatedTime').textContent = timeString;
            }
          
            // Update time initially and set interval to update every minute
            updateLastUpdatedTime();
            setInterval(updateLastUpdatedTime, 60000);
            // --- Realistic Battery Data with AC Active Power ---
            const batteryData = {
                alias: "SSC-Smart-Logger-01",
                soc: 72,
                voltageMax: 408,
                voltageMin: 392,
                tempMax: 38,
                tempMin: 26,
                health: 87,
                power: 125,
                warning: 0,
                current: 28,
                availableChargeEnergy: 720,
                availableDischargeEnergy: 580,
                maxChargePower: 280,
                maxDischargePower: 450,
                totalCapacity: 1000,
                // KEY FIELDS FOR MODE DETECTION:
                acActivePower: -42, // Negative = Charging, Positive = Discharging
                acReactivePower: 18,
                state: "operating",
                energyYieldAbsorbed: 12500, // Total energy absorbed (charged)
                energyYieldExport: 8900 // Total energy exported (discharged)
            };
            // --- Battery Mode Detection ---
            function determineBatteryMode() {
                const activePower = batteryData.acActivePower;
              
                if (activePower < -1) { // Negative power = charging
                    return {
                        mode: "charging",
                        description: "Charging",
                        icon: "‚ö°",
                        color: "#00bfff",
                        powerClass: "power-negative",
                        flowDirection: "grid-to-battery"
                    };
                } else if (activePower > 1) { // Positive power = discharging
                    return {
                        mode: "discharging",
                        description: "Discharging",
                        icon: "üîã",
                        color: "#ff9800",
                        powerClass: "power-positive",
                        flowDirection: "battery-to-grid"
                    };
                } else {
                    return {
                        mode: "idle",
                        description: "Idle / Standby",
                        icon: "‚è∏",
                        color: "#4CAF50",
                        powerClass: "power-zero",
                        flowDirection: "no-flow"
                    };
                }
            }
            function updateModeIndicator() {
                const modeInfo = determineBatteryMode();
                const modeElement = document.getElementById('modeIndicator');
              
                if (modeElement) {
                    modeElement.innerHTML = `
                        <div class="mode-icon ${modeInfo.mode}" style="color: ${modeInfo.color}">
                            <span>${modeInfo.icon}</span>
                        </div>
                        <div class="mode-text">${modeInfo.description}</div>
                        <div class="power-flow ${modeInfo.powerClass}">${batteryData.acActivePower} kW</div>
                    `;
                }
            }
          
            function updatePowerFlowDiagram() {
                const modeInfo = determineBatteryMode();
                const diagramElement = document.getElementById('powerFlowDiagram');
              
                if (diagramElement) {
                    let sourceIcon, targetIcon, flowArrow, flowLabel;
                  
                    if (modeInfo.mode === "charging") {
                        sourceIcon = "üè¢"; // Grid icon
                        targetIcon = "üîã"; // Battery icon
                        flowArrow = "‚Üí"; // Right arrow for grid to battery
                        flowLabel = "Grid ‚Üí Battery";
                    } else if (modeInfo.mode === "discharging") {
                        sourceIcon = "üîã"; // Battery icon
                        targetIcon = "üè¢"; // Grid icon
                        flowArrow = "‚Üí"; // Right arrow for battery to grid
                        flowLabel = "Battery ‚Üí Grid";
                    } else {
                        sourceIcon = "üîã"; // Battery icon
                        targetIcon = "üè¢"; // Grid icon
                        flowArrow = "‚áÑ"; // Bidirectional arrow for idle
                        flowLabel = "No Power Flow";
                    }
                  
                    diagramElement.innerHTML = `
                        <div class="power-source">
                            <div class="power-source-icon">${sourceIcon}</div>
                            <div class="power-source-label">${modeInfo.mode === "charging" ? "Grid" : "Battery"}</div>
                        </div>
                        <div class="power-flow-arrow ${modeInfo.mode}">${flowArrow}</div>
                        <div class="power-source">
                            <div class="power-source-icon">${targetIcon}</div>
                            <div class="power-source-label">${modeInfo.mode === "charging" ? "Battery" : "Grid"}</div>
                        </div>
                        <div style="width: 100%; text-align: center; margin-top: 15px;">
                            <div class="power-flow-value ${modeInfo.powerClass}">${Math.abs(batteryData.acActivePower)} kW</div>
                            <div class="power-flow-label">${flowLabel}</div>
                        </div>
                    `;
                }
            }
          
            // --- Update Alert Indicators ---
            function updateAlertIndicators() {
                // SOC Alert - critical if below 20% or above 90%
                const socAlert = document.getElementById('socAlert');
                if (batteryData.soc < 20 || batteryData.soc > 90) {
                    socAlert.className = 'alert-indicator alert-critical';
                } else if (batteryData.soc < 30 || batteryData.soc > 80) {
                    socAlert.className = 'alert-indicator alert-warning';
                } else {
                    socAlert.className = 'alert-indicator';
                }
              
                // Health Alert - critical if below 70%
                const healthAlert = document.getElementById('healthAlert');
                if (batteryData.health < 70) {
                    healthAlert.className = 'alert-indicator alert-critical';
                } else if (batteryData.health < 80) {
                    healthAlert.className = 'alert-indicator alert-warning';
                } else {
                    healthAlert.className = 'alert-indicator';
                }
              
                // Error Alert
                const errorAlert = document.getElementById('errorAlert');
                if (batteryData.warning === 2) {
                    errorAlert.className = 'alert-indicator alert-critical';
                } else if (batteryData.warning === 1) {
                    errorAlert.className = 'alert-indicator alert-warning';
                } else {
                    errorAlert.className = 'alert-indicator';
                }
              
                // Temperature Alert - critical if above 45¬∞C
                const tempAlert = document.getElementById('tempAlert');
                if (batteryData.tempMax > 45) {
                    tempAlert.className = 'alert-indicator alert-critical';
                } else if (batteryData.tempMax > 40) {
                    tempAlert.className = 'alert-indicator alert-warning';
                } else {
                    tempAlert.className = 'alert-indicator';
                }
              
                // Voltage Alert - critical if outside safe range
                const voltageAlert = document.getElementById('voltageAlert');
                if (batteryData.voltageMin < 370 || batteryData.voltageMax > 430) {
                    voltageAlert.className = 'alert-indicator alert-critical';
                } else if (batteryData.voltageMin < 380 || batteryData.voltageMax > 420) {
                    voltageAlert.className = 'alert-indicator alert-warning';
                } else {
                    voltageAlert.className = 'alert-indicator';
                }
              
                // Update system status
                const systemStatus = document.getElementById('systemStatus');
                if (batteryData.warning === 2 || batteryData.soc < 10 || batteryData.tempMax > 50) {
                    systemStatus.className = 'status-badge status-critical';
                    systemStatus.textContent = 'System Critical';
                } else if (batteryData.warning === 1 || batteryData.soc < 20 || batteryData.tempMax > 45) {
                    systemStatus.className = 'status-badge status-warning';
                    systemStatus.textContent = 'System Warning';
                } else {
                    systemStatus.className = 'status-badge status-normal';
                    systemStatus.textContent = 'System Normal';
                }
            }
          
            // Update mode indicator and alerts
            updateModeIndicator();
            updatePowerFlowDiagram();
            updateAlertIndicators();
            // --- Dummy Historical Data for Trends ---
            function generateHistoricalData(count, startValue, fluctuation, min, max) {
                let data = [];
                let firstDate = new Date();
                firstDate.setHours(firstDate.getHours() - count);
                let value = startValue;
                for (let i = 0; i < count; i++) {
                    let newDate = new Date(firstDate);
                    newDate.setHours(newDate.getHours() + i);
                    value += (Math.random() - 0.5) * fluctuation;
                    if (value < min) value = min;
                    if (value > max) value = max;
                    data.push({ date: newDate, value: value });
                }
                return data;
            }
            const historicalVoltageMax = generateHistoricalData(24, batteryData.voltageMax, 3, 380, 420);
            const historicalVoltageMin = generateHistoricalData(24, batteryData.voltageMin, 3, 380, 420);
            const historicalTempMax = generateHistoricalData(24, batteryData.tempMax, 2, 20, 45);
            const historicalTempMin = generateHistoricalData(24, batteryData.tempMin, 2, 20, 45);
          
            // --- 2. Health Gauge Chart ---
            let healthChart = am4core.create("healthChart", am4charts.GaugeChart);
            healthChart.innerRadius = am4core.percent(80);
            let healthAxis = healthChart.xAxes.push(new am4charts.ValueAxis());
            healthAxis.min = 0; healthAxis.max = 100;
            healthAxis.strictMinMax = true;
            configureAxis(healthAxis);
            healthAxis.renderer.labels.template.radius = am4core.percent(110);
            let range1 = healthAxis.axisRanges.create();
            range1.value = 0; range1.endValue = 40;
            range1.axisFill.fillOpacity = 1;
            range1.axisFill.fill = am4core.color("#F44336");
            range1.axisFill.stroke = am4core.color("#F44336");
            range1.axisFill.strokeWidth = 2;
            let range2 = healthAxis.axisRanges.create();
            range2.value = 40; range2.endValue = 80;
            range2.axisFill.fillOpacity = 1;
            range2.axisFill.fill = am4core.color("#FFC107");
            range2.axisFill.stroke = am4core.color("#FFC107");
            range2.axisFill.strokeWidth = 2;
            let range3 = healthAxis.axisRanges.create();
            range3.value = 80; range3.endValue = 100;
            range3.axisFill.fillOpacity = 1;
            range3.axisFill.fill = am4core.color("#4CAF50");
            range3.axisFill.stroke = am4core.color("#4CAF50");
            range3.axisFill.strokeWidth = 2;
            let healthHand = healthChart.hands.push(new am4charts.ClockHand());
            healthHand.value = batteryData.health;
            healthHand.pin.disabled = true;
            healthHand.fill = am4core.color("#fff");
            healthHand.stroke = am4core.color("#fff");
            healthHand.radius = am4core.percent(70);
            healthChart.events.on("ready", function() {
                let healthLabel = healthChart.radarContainer.createChild(am4core.Label);
                healthLabel.isMeasured = false;
                healthLabel.fontSize = "2em";
                healthLabel.horizontalCenter = "middle";
                healthLabel.verticalCenter = "bottom";
                healthLabel.text = `${batteryData.health}%`;
                healthLabel.fill = am4core.color("#fff");
              
                let healthSubLabel = healthChart.radarContainer.createChild(am4core.Label);
                healthSubLabel.isMeasured = false;
                healthSubLabel.fontSize = "1em";
                healthSubLabel.horizontalCenter = "middle";
                healthSubLabel.verticalCenter = "top";
                healthSubLabel.dy = 20;
                if (batteryData.health >= 80) {
                    healthSubLabel.text = "EXCELLENT";
                    healthSubLabel.fill = am4core.color("#4CAF50");
                } else if (batteryData.health >= 40) {
                    healthSubLabel.text = "GOOD";
                    healthSubLabel.fill = am4core.color("#FFC107");
                } else {
                    healthSubLabel.text = "POOR";
                    healthSubLabel.fill = am4core.color("#F44336");
                }
            });
            // --- Traffic Light for System Status ---
            function createTrafficLight() {
                const statusDiv = document.getElementById('stateErrorChart');
                const isGreen = batteryData.warning === 0;
                const statusText = isGreen ? 'Normal' : 'Error';
                const textColor = isGreen ? '#4CAF50' : '#F44336';
                statusDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                        <div class="traffic-light">
                            <div class="light red ${!isGreen ? 'active' : ''}"></div>
                            <div class="light green ${isGreen ? 'active' : ''}"></div>
                        </div>
                        <p style="margin-top: 20px; font-size: 1.2rem; color: ${textColor};">${statusText}</p>
                    </div>
                `;
            }
            createTrafficLight();
            // --- 4. Voltage Trends Chart ---
            let voltageTrendChart = am4core.create("voltageTrendChart", am4charts.XYChart);
            voltageTrendChart.data = historicalVoltageMax.map((item, i) => ({
                date: item.date,
                voltageMax: item.value,
                voltageMin: historicalVoltageMin[i].value
            }));
          
            let voltageDateAxis = voltageTrendChart.xAxes.push(new am4charts.DateAxis());
            configureAxis(voltageDateAxis);
            voltageDateAxis.renderer.labels.template.rotation = -45;
            voltageDateAxis.renderer.labels.template.horizontalCenter = "right";
            voltageDateAxis.renderer.labels.template.verticalCenter = "middle";
            voltageDateAxis.tooltipDateFormat = "MMM dd, HH:mm";
            let voltageValueAxis = voltageTrendChart.yAxes.push(new am4charts.ValueAxis());
            voltageValueAxis.title.text = "Voltage (V)";
            voltageValueAxis.title.fill = am4core.color("#e0e0e0");
            configureAxis(voltageValueAxis);
            voltageValueAxis.min = 350;
            voltageValueAxis.max = 450;
            let voltMaxSeries = voltageTrendChart.series.push(new am4charts.LineSeries());
            voltMaxSeries.dataFields.dateX = "date";
            voltMaxSeries.dataFields.valueY = "voltageMax";
            voltMaxSeries.name = "Voltage Max";
            voltMaxSeries.stroke = am4core.color("#00bfff");
            voltMaxSeries.strokeWidth = 3;
            voltMaxSeries.tooltipText = "{name}: [bold]{valueY}V[/]";
            voltMaxSeries.minBulletDistance = 15;
            voltMaxSeries.tensionX = 0.8;
            voltMaxSeries.fill = am4core.color("#00bfff");
            voltMaxSeries.fillOpacity = 0.1;
            let voltMinSeries = voltageTrendChart.series.push(new am4charts.LineSeries());
            voltMinSeries.dataFields.dateX = "date";
            voltMinSeries.dataFields.valueY = "voltageMin";
            voltMinSeries.name = "Voltage Min";
            voltMinSeries.stroke = am4core.color("#ff9800");
            voltMinSeries.strokeWidth = 3;
            voltMinSeries.tooltipText = "{name}: [bold]{valueY}V[/]";
            voltMinSeries.minBulletDistance = 15;
            voltMinSeries.tensionX = 0.8;
            voltMinSeries.fill = am4core.color("#ff9800");
            voltMinSeries.fillOpacity = 0.1;
            voltageTrendChart.legend = new am4charts.Legend();
            voltageTrendChart.legend.labels.template.fill = am4core.color("#e0e0e0");
            voltageTrendChart.legend.valueLabels.template.fill = am4core.color("#e0e0e0");
            voltageTrendChart.cursor = new am4charts.XYCursor();
            voltageTrendChart.cursor.xAxis = voltageDateAxis;
            // --- 5. Temperature Trends Chart ---
            let temperatureTrendChart = am4core.create("temperatureTrendChart", am4charts.XYChart);
            temperatureTrendChart.data = historicalTempMax.map((item, i) => ({
                date: item.date,
                tempMax: item.value,
                tempMin: historicalTempMin[i].value
            }));
          
            let tempDateAxis = temperatureTrendChart.xAxes.push(new am4charts.DateAxis());
            configureAxis(tempDateAxis);
            tempDateAxis.renderer.labels.template.rotation = -45;
            tempDateAxis.renderer.labels.template.horizontalCenter = "right";
            tempDateAxis.renderer.labels.template.verticalCenter = "middle";
            tempDateAxis.tooltipDateFormat = "MMM dd, HH:mm";
            let tempValueAxis = temperatureTrendChart.yAxes.push(new am4charts.ValueAxis());
            tempValueAxis.title.text = "Temperature (¬∞C)";
            tempValueAxis.title.fill = am4core.color("#e0e0e0");
            configureAxis(tempValueAxis);
            tempValueAxis.min = 10;
            tempValueAxis.max = 50;
            let tempMaxSeries = temperatureTrendChart.series.push(new am4charts.LineSeries());
            tempMaxSeries.dataFields.dateX = "date";
            tempMaxSeries.dataFields.valueY = "tempMax";
            tempMaxSeries.name = "Temp Max";
            tempMaxSeries.stroke = am4core.color("#F44336");
            tempMaxSeries.strokeWidth = 3;
            tempMaxSeries.tooltipText = "{name}: [bold]{valueY}¬∞C[/]";
            tempMaxSeries.minBulletDistance = 15;
            tempMaxSeries.tensionX = 0.8;
            tempMaxSeries.fill = am4core.color("#F44336");
            tempMaxSeries.fillOpacity = 0.1;
            let tempMinSeries = temperatureTrendChart.series.push(new am4charts.LineSeries());
            tempMinSeries.dataFields.dateX = "date";
            tempMinSeries.dataFields.valueY = "tempMin";
            tempMinSeries.name = "Temp Min";
            tempMinSeries.stroke = am4core.color("#4CAF50");
            tempMinSeries.strokeWidth = 3;
            tempMinSeries.tooltipText = "{name}: [bold]{valueY}¬∞C[/]";
            tempMinSeries.minBulletDistance = 15;
            tempMinSeries.tensionX = 0.8;
            tempMinSeries.fill = am4core.color("#4CAF50");
            tempMinSeries.fillOpacity = 0.1;
            temperatureTrendChart.legend = new am4charts.Legend();
            temperatureTrendChart.legend.labels.template.fill = am4core.color("#e0e0e0");
            temperatureTrendChart.legend.valueLabels.template.fill = am4core.color("#e0e0e0");
            temperatureTrendChart.cursor = new am4charts.XYCursor();
            temperatureTrendChart.cursor.xAxis = tempDateAxis;
            // --- 6. Max Charge/Discharge Power Chart ---
            let powerChart = am4core.create("powerChart", am4charts.XYChart);
            powerChart.data = [{
                category: "Power",
                charge: batteryData.maxChargePower,
                discharge: batteryData.maxDischargePower
            }];
            let powerCategoryAxis = powerChart.xAxes.push(new am4charts.CategoryAxis());
            powerCategoryAxis.dataFields.category = "category";
            powerCategoryAxis.renderer.grid.template.disabled = true;
            powerCategoryAxis.renderer.labels.template.disabled = true;
            let powerValueAxis = powerChart.yAxes.push(new am4charts.ValueAxis());
            powerValueAxis.min = 0;
            powerValueAxis.max = Math.max(batteryData.maxChargePower, batteryData.maxDischargePower) * 1.2;
            configureAxis(powerValueAxis);
            let chargePowerSeries = powerChart.series.push(new am4charts.ColumnSeries());
            chargePowerSeries.dataFields.valueY = "charge";
            chargePowerSeries.dataFields.categoryX = "category";
            chargePowerSeries.name = "Max Charge Power";
            let chargeGradient = new am4core.LinearGradient();
            chargeGradient.addColor(am4core.color("#00bfff").lighten(0.3));
            chargeGradient.addColor(am4core.color("#00bfff"));
            chargeGradient.rotation = 90;
            chargePowerSeries.columns.template.fill = chargeGradient;
            chargePowerSeries.columns.template.stroke = am4core.color("#00bfff");
            chargePowerSeries.columns.template.strokeWidth = 2;
            chargePowerSeries.columns.template.tooltipText = "{name}: {valueY} kW";
            chargePowerSeries.columns.template.width = am4core.percent(35);
            chargePowerSeries.columns.template.dx = -10;
            chargePowerSeries.fillOpacity = 0.3;
            let dischargePowerSeries = powerChart.series.push(new am4charts.ColumnSeries());
            dischargePowerSeries.dataFields.valueY = "discharge";
            dischargePowerSeries.dataFields.categoryX = "category";
            dischargePowerSeries.name = "Max Discharge Power";
            let dischargeGradient = new am4core.LinearGradient();
            dischargeGradient.addColor(am4core.color("#ff9800").lighten(0.1));
            dischargeGradient.addColor(am4core.color("#ff9800"));
            dischargeGradient.rotation = 90;
            dischargePowerSeries.columns.template.fill = dischargeGradient;
            dischargePowerSeries.columns.template.stroke = am4core.color("#ff9800");
            dischargePowerSeries.columns.template.tooltipText = "{name}: {valueY} kW";
            dischargePowerSeries.columns.template.width = am4core.percent(35);
            dischargePowerSeries.columns.template.dx = -10;
            dischargePowerSeries.fillOpacity = 0.3;
            powerChart.legend = new am4charts.Legend();
            powerChart.legend.labels.template.fill = am4core.color("#e0e0e0");
            powerChart.legend.valueLabels.template.fill = am4core.color("#e0e0e0");
            // --- AC Active/Reactive Power ---
            let acPowerChart = am4core.create("acPowerChart", am4charts.XYChart);
            function generateACPowerData(count) {
                let data = [];
                let firstDate = new Date();
                firstDate.setMinutes(firstDate.getMinutes() - count);
                for (let i = 0; i < count; i++) {
                    let newDate = new Date(firstDate);
                    newDate.setMinutes(newDate.getMinutes() + i);
                    data.push({
                        date: newDate,
                        active: Math.round(Math.random() * 100 - 50),
                        reactive: Math.round(Math.random() * 60 - 30)
                    });
                }
                return data;
            }
            acPowerChart.data = generateACPowerData(30);
          
            let acDateAxis = acPowerChart.xAxes.push(new am4charts.DateAxis());
            configureAxis(acDateAxis);
            acDateAxis.tooltipDateFormat = "HH:mm";
          
            let acPowerValueAxis = acPowerChart.yAxes.push(new am4charts.ValueAxis());
            configureAxis(acPowerValueAxis);
            acPowerValueAxis.title.text = "Power (kW/kVAR)";
            acPowerValueAxis.title.fill = am4core.color("#e0e0e0");
            function createACPowerSeries(field, name, color) {
                let series = acPowerChart.series.push(new am4charts.LineSeries());
                series.dataFields.valueY = field;
                series.dataFields.dateX = "date";
                series.name = name;
                series.tooltipText = "{name}: [bold]{valueY}[/]";
                series.strokeWidth = 3;
                series.stroke = am4core.color(color);
                series.minBulletDistance = 15;
                series.tensionX = 0.8;
                series.fill = am4core.color(color);
                series.fillOpacity = 0.1;
                return series;
            }
            let activeSeries = createACPowerSeries("active", "Active Power", "#00bfff");
            let reactiveSeries = createACPowerSeries("reactive", "Reactive Power", "#ff9800");
            acPowerChart.legend = new am4charts.Legend();
            acPowerChart.legend.labels.template.fill = am4core.color("#e0e0e0");
            acPowerChart.legend.valueLabels.template.fill = am4core.color("#e0e0e0");
            acPowerChart.cursor = new am4charts.XYCursor();
            acPowerChart.cursor.xAxis = acDateAxis;
            // --- AC Power Gauge Chart ---
            function createACPowerGauge(divId, activeValue, reactiveValue, minRange, maxRange) {
                let chart = am4core.create(divId, am4charts.GaugeChart);
                chart.innerRadius = am4core.percent(80);
                let axis = chart.xAxes.push(new am4charts.ValueAxis());
                axis.min = minRange;
                axis.max = maxRange;
                axis.strictMinMax = true;
                configureAxis(axis);
                axis.renderer.labels.template.radius = am4core.percent(10);
                let activeHand = chart.hands.push(new am4charts.ClockHand());
                activeHand.value = activeValue;
                activeHand.pin.radius = 10;
                activeHand.fill = am4core.color("#00bfff");
                activeHand.stroke = am4core.color("#00bfff");
                activeHand.radius = am4core.percent(70);
                let reactiveHand = chart.hands.push(new am4charts.ClockHand());
                reactiveHand.value = reactiveValue;
                reactiveHand.pin.radius = 10;
                reactiveHand.fill = am4core.color("#ff9800");
                reactiveHand.stroke = am4core.color("#ff9800");
                reactiveHand.radius = am4core.percent(60); // Slightly shorter for distinction
                chart.events.on("ready", function() {
                    let activeLabel = chart.radarContainer.createChild(am4core.Label);
                    activeLabel.text = `Active: ${activeValue} kW`;
                    activeLabel.fontSize = "1em";
                    activeLabel.fill = am4core.color("#00bfff");
                    activeLabel.horizontalCenter = "middle";
                    activeLabel.verticalCenter = "bottom";
                    activeLabel.dy = 30;
                    let reactiveLabel = chart.radarContainer.createChild(am4core.Label);
                    reactiveLabel.text = `Reactive: ${reactiveValue} kVAR`;
                    reactiveLabel.fontSize = "1em";
                    reactiveLabel.fill = am4core.color("#ff9800");
                    reactiveLabel.horizontalCenter = "middle";
                    reactiveLabel.verticalCenter = "bottom";
                    reactiveLabel.dy = 45;
                });
            }
            createACPowerGauge("acPowerGaugeChart", batteryData.acActivePower, batteryData.acReactivePower, -100, 100);
            // Update energy values, battery fill, and SOC label
            function updateEnergyAndSOC() {
                document.getElementById('chargeEnergyValue').textContent = batteryData.availableChargeEnergy + ' kWh';
                document.getElementById('dischargeEnergyValue').textContent = batteryData.availableDischargeEnergy + ' kWh';
                document.getElementById('batteryFill').style.height = batteryData.soc + '%';
                document.getElementById('socLabel').textContent = batteryData.soc + '%';
            }
            updateEnergyAndSOC();

            // --- Update Thermometer for Temperature ---
            function updateThermometer() {
                const maxTemp = 60; // Assuming max scale for thermometer
                document.getElementById('tempMinFill').style.height = (batteryData.tempMin / maxTemp * 100) + '%';
                document.getElementById('tempMaxFill').style.height = (batteryData.tempMax / maxTemp * 100) + '%';
                document.getElementById('tempMinLabel').textContent = `Min: ${batteryData.tempMin}¬∞C`;
                document.getElementById('tempMaxLabel').textContent = `Max: ${batteryData.tempMax}¬∞C`;
            }
            updateThermometer();

            // --- Update Voltmeter for Voltage ---
            function updateVoltmeter() {
                const minVoltageRange = 350;
                const maxVoltageRange = 450;
                const range = maxVoltageRange - minVoltageRange;

                const minAngle = ((batteryData.voltageMin - minVoltageRange) / range) * 180 - 90;
                const maxAngle = ((batteryData.voltageMax - minVoltageRange) / range) * 180 - 90;

                document.getElementById('voltageMinNeedle').style.transform = `rotate(${minAngle}deg)`;
                document.getElementById('voltageMaxNeedle').style.transform = `rotate(${maxAngle}deg)`;
                document.getElementById('voltageMinLabel').textContent = `Min: ${batteryData.voltageMin}V`;
                document.getElementById('voltageMaxLabel').textContent = `Max: ${batteryData.voltageMax}V`;
            }
            updateVoltmeter();
          
            // Simulate data updates every 5 seconds for demo
            setInterval(function() {
                // Simulate realistic battery behavior
                const modeChange = Math.random();
                if (modeChange > 0.7) {
                    // Change between charging and discharging
                    batteryData.acActivePower = batteryData.acActivePower > 0 ?
                        -Math.random() * 50 - 10 : // Switch to charging
                        Math.random() * 40 + 10; // Switch to discharging
                } else {
                    // Small fluctuations in current mode
                    batteryData.acActivePower += (Math.random() - 0.5) * 5;
                }
              
                // Update SOC based on power flow
                const socChange = batteryData.acActivePower / 1000; // Small SOC change
                batteryData.soc = Math.max(0, Math.min(100, batteryData.soc + socChange));
              
                // Update available energy based on mode
                if (batteryData.acActivePower < 0) {
                    // Charging: decrease available charge, increase available discharge
                    batteryData.availableChargeEnergy = Math.max(0, batteryData.availableChargeEnergy + batteryData.acActivePower / 10);
                    batteryData.availableDischargeEnergy = Math.min(batteryData.totalCapacity, batteryData.availableDischargeEnergy - batteryData.acActivePower / 10);
                } else {
                    // Discharging: increase available charge, decrease available discharge
                    batteryData.availableChargeEnergy = Math.min(batteryData.totalCapacity, batteryData.availableChargeEnergy - batteryData.acActivePower / 10);
                    batteryData.availableDischargeEnergy = Math.max(0, batteryData.availableDischargeEnergy + batteryData.acActivePower / 10);
                }
              
                // Update mode indicator and alerts
                updateModeIndicator();
                updatePowerFlowDiagram();
                updateAlertIndicators();
                // Update energy values, battery fill, and SOC
                updateEnergyAndSOC();
                // Update thermometer and voltmeter
                updateThermometer();
                updateVoltmeter();
                // Update last updated time
                updateLastUpdatedTime();
            }, 5000); // Update every 5 seconds for demo
        });
    </script>
</body>
</html>