<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>কুমিল্লা-৪ ভোটার ড্যাশবোর্ড (বাংলা নাম সহ)</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2canvas + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    #map { height: 400px; width: 100%; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-top: 10px; }
    canvas { max-width: 100%; height: auto; }
    .popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; text-align: center; max-width: 80%; }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    select { min-width: 150px; }
    .sources { background: #f3f4f6; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 0.9rem; }
    .sources a { color: #3b82f6; text-decoration: underline; font-weight: 500; }
    .analysis-section { background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 20px; }
    .tab-button { padding: 8px 16px; border: none; background: #e5e7eb; cursor: pointer; border-radius: 4px; }
    .tab-button.active { background: #3b82f6; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen p-4 font-sans">
  <div class="max-w-7xl mx-auto">
    <!-- হেডার -->
    <header class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-blue-800">কুমিল্লা-৪ ভোটার ড্যাশবোর্ড (সম্পূর্ণ ১৫ ইউনিয়ন)</h1>
      <p class="text-gray-600 mt-2">দেবিদ্বার উপজেলা + ইউনিয়ন ভিত্তিক ইন্টারঅ্যাকটিভ বিশ্লেষণ + ম্যাপ (২০২৬)</p>
      <div class="sources">
        <strong>ডেটা সূত্র:</strong>
        <a href="https://bbs.portal.gov.bd/sites/default/files/files/bbs.portal.gov.bd/page/b343a8b4_956b_45ca_872f_4cf9b2f1a6e0/2024-01-31-15-51-b53c55dd692233ae401ba013060b9cbb.pdf" target="_blank">BBS ২০২২ Census</a> |
        <a href="https://www.ecs.gov.bd/" target="_blank">EC Voter List (ড্রাফট ২০২৫)</a> |
        <a href="https://en.wikipedia.org/wiki/Debidwar_Upazila" target="_blank">Wikipedia Debidwar</a> |
        <a href="https://github.com/yasserius/bangladesh_geojson_shapefile" target="_blank">GeoJSON</a>
      </div>
    </header>

    <!-- ফিল্টার -->
    <div class="mb-6 flex flex-wrap justify-center gap-3">
      <select id="upazilaFilter" class="px-4 py-2 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="debidwar">দেবিদ্বার উপজেলা</option>
      </select>
      <select id="unionFilter" class="px-4 py-2 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">সকল ইউনিয়ন (১৫টি)</option>
      </select>
      <button onclick="downloadPDF()" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition">PDF ডাউনলোড</button>
    </div>

    <!-- চার্ট গ্রিড -->
    <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-3 text-center">লিঙ্গ অনুপাত</h3>
        <canvas id="genderChart"></canvas>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-3 text-center">বয়স গ্রুপ</h3>
        <canvas id="ageChart"></canvas>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-3 text-center">ধর্মীয় গঠন</h3>
        <canvas id="religionChart"></canvas>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-3 text-center">শিক্ষা স্তর</h3>
        <canvas id="educationChart"></canvas>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-3 text-center">পেশা বিতরণ</h3>
        <canvas id="occupationChart"></canvas>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-3 text-center">ভোটার টার্নআউট ইতিহাস</h3>
        <canvas id="turnoutChart"></canvas>
      </div>
    </div>

    <!-- ইন্টারঅ্যাকটিভ ম্যাপ -->
    <div class="bg-white p-5 rounded-xl shadow-lg mb-6">
      <h3 class="text-lg font-semibold mb-3 text-center">ইউনিয়ন ম্যাপ (ক্লিক করুন ডেটা দেখার জন্য)</h3>
      <div id="map"></div>
    </div>

    <!-- বিশ্লেষণ সেকশন -->
    <div class="analysis-section">
      <h2 class="text-2xl font-bold mb-4">কুমিল্লা-৪ বিশ্লেষণ</h2>
      <!-- ট্যাব নেভিগেশন -->
      <div class="flex gap-2 mb-4">
        <button class="tab-button active" onclick="openTab('demographics')">১. Demographic Data</button>
        <button class="tab-button" onclick="openTab('voter-data')">২. Voter Data</button>
        <button class="tab-button" onclick="openTab('sentiment')">৩. Political Sentiment</button>
        <button class="tab-button" onclick="openTab('issues')">৪. Local Issues</button>
        <button class="tab-button" onclick="openTab('community')">৫. Community Mapping</button>
      </div>

      <!-- ট্যাব কন্টেন্ট -->
      <div id="demographics" class="tab-content active">
        <table class="w-full border-collapse border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 p-2">ক্যাটাগরি</th>
              <th class="border border-gray-300 p-2">তথ্য</th>
              <th class="border border-gray-300 p-2">প্রচারণা টিপ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-gray-300 p-2">বয়স বিতরণ</td>
              <td class="border border-gray-300 p-2">যুবক (১৮-৩৫): ৪৭%, বয়স্ক (৫১+): ২৫%</td>
              <td class="border border-gray-300 p-2">যুবকদের জন্য সোশ্যাল মিডিয়া, বয়স্কদের জন্য গ্রামীণ মিটিং</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">লিঙ্গ অনুপাত</td>
              <td class="border border-gray-300 p-2">পুরুষ ৪৬.৩৪%, মহিলা ৫৩.৬৬%</td>
              <td class="border border-gray-300 p-2">মহিলা-কেন্দ্রিক প্রতিশ্রুতি (স্বাস্থ্য, শিক্ষা)</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">শিক্ষা স্তর</td>
              <td class="border border-gray-300 p-2">সাক্ষরতা ৭৬.৫৬%, অশিক্ষিত ২৩%</td>
              <td class="border border-gray-300 p-2">নিম্নশিক্ষিতদের জন্য সহজ ভাষায় মিটিং</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">পেশা</td>
              <td class="border border-gray-300 p-2">কৃষি ৭০%, ব্যবসা ১৫%, চাকরি ১০%</td>
              <td class="border border-gray-300 p-2">কৃষকদের জন্য সাবসিডি প্রতিশ্রুতি</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">আয় স্তর</td>
              <td class="border border-gray-300 p-2">গড় মাসিক ১২,০০০ টাকা, দারিদ্র্য ১৯.৫%</td>
              <td class="border border-gray-300 p-2">দারিদ্র্য-কমানো প্রোগ্রাম প্রচার</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">শহর-গ্রাম</td>
              <td class="border border-gray-300 p-2">৮৫% গ্রামীণ</td>
              <td class="border border-gray-300 p-2">গ্রামে দরজা-দরজা ক্যাম্পেইন</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">ধর্ম/জাতি</td>
              <td class="border border-gray-300 p-2">মুসলিম ৯৫%, হিন্দু ৪.৫%</td>
              <td class="border border-gray-300 p-2">হিন্দু এলাকায় সুরক্ষা-কেন্দ্রিক মেসেজ</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="voter-data" class="tab-content">
        <table class="w-full border-collapse border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 p-2">ক্যাটাগরি</th>
              <th class="border border-gray-300 p-2">তথ্য</th>
              <th class="border border-gray-300 p-2">প্রচারণা টিপ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-gray-300 p-2">নিবন্ধিত ভোটার</td>
              <td class="border border-gray-300 p-2">৩.৮৮ লাখ (অনুমানিক, পুরুষ ১.৯৭ লাখ, মহিলা ১.৯২ লাখ)</td>
              <td class="border border-gray-300 p-2">সদরে বেশি ফোকাস, মোবাইল ভ্যান</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">ভোটার টার্নআউট</td>
              <td class="border border-gray-300 p-2">২০১৮: ৮০.২%, ২০২৪: ৪০%</td>
              <td class="border border-gray-300 p-2">৬০%+ লক্ষ্য, গ্রামে মোবিলাইজেশন</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">মার্জিন অফ ভিক্টরি</td>
              <td class="border border-gray-300 p-2">২০১৮: AL ১,৮১,৭২৫ ভোট (১,০০,০০০+)</td>
              <td class="border border-gray-300 p-2">AL-এর বেস শক্তিশালী, BNP সুইং এলাকায় ফোকাস</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">পোলিং সেন্টার</td>
              <td class="border border-gray-300 p-2">১৫০+ (স্কুল/কলেজে)</td>
              <td class="border border-gray-300 p-2">সেন্টার কাছে সচেতনতা ক্যাম্প</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">সুইং এরিয়া</td>
              <td class="border border-gray-300 p-2">মোহনপুর, রাজামেহের</td>
              <td class="border border-gray-300 p-2">দ্বিগুণ ক্যাম্পেইন, লোকাল নেতাদের সাথে</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">স্ট্রংহোল্ড</td>
              <td class="border border-gray-300 p-2">বরকামতা, ধামতী</td>
              <td class="border border-gray-300 p-2">রক্ষণাবেক্ষণ-কেন্দ্রিক ক্যাম্পেইন</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">ভোটার আইডি কভারেজ</td>
              <td class="border border-gray-300 p-2">৯৮%+ (আপডেট ৯৫%)</td>
              <td class="border border-gray-300 p-2">অবশিষ্ট ২% এর জন্য মোবাইল ক্যাম্প</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="sentiment" class="tab-content">
        <table class="w-full border-collapse border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 p-2">ক্যাটাগরি</th>
              <th class="border border-gray-300 p-2">তথ্য</th>
              <th class="border border-gray-300 p-2">প্রচারণা টিপ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-gray-300 p-2">পাবলিক অপিনিয়ন</td>
              <td class="border border-gray-300 p-2">AL ৬৫%, BNP ২৫% (EC ২০২৫)</td>
              <td class="border border-gray-300 p-2">AL-এর ছবি শক্তিশালী করুন</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">সোশ্যাল মিডিয়া সেন্টিমেন্ট</td>
              <td class="border border-gray-300 p-2">X-এ ৭০% AL-এর পক্ষে</td>
              <td class="border border-gray-300 p-2">ফেসবুক অ্যাডস চালান</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">কী ইস্যু</td>
              <td class="border border-gray-300 p-2">মূল্যস্ফীতি ৮৫%, বেকারত্ব ৭০%</td>
              <td class="border border-gray-300 p-2">মূল্যস্ফীতি কমানোর পরিকল্পনা</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">উন্নয়ন ধারণা</td>
              <td class="border border-gray-300 p-2">রাস্তা ৬৫% সন্তুষ্টি, স্বাস্থ্য ৪০%</td>
              <td class="border border-gray-300 p-2">স্থানীয় উন্নয়নের ছবি দেখান</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">দল/প্রার্থী ইমেজ</td>
              <td class="border border-gray-300 p-2">AL বিশ্বাস ৬৫%, BNP ৩৫%</td>
              <td class="border border-gray-300 p-2">স্থিতিশীলতার ছবি</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="issues" class="tab-content">
        <table class="w-full border-collapse border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 p-2">ক্যাটাগরি</th>
              <th class="border border-gray-300 p-2">তথ্য</th>
              <th class="border border-gray-300 p-2">প্রচারণা টিপ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-gray-300 p-2">রাস্তা/পরিবহন</td>
              <td class="border border-gray-300 p-2">৬৫% পাকা রাস্তা, বন্যায় ক্ষতি</td>
              <td class="border border-gray-300 p-2">বন্যা-প্রতিরোধী রাস্তা প্রতিশ্রুতি</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">বিদ্যুৎ/পানি</td>
              <td class="border border-gray-300 p-2">বিদ্যুৎ ৮৫%, পানি ৭০%</td>
              <td class="border border-gray-300 p-2">সৌর বিদ্যুৎ প্রকল্প</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">স্বাস্থ্য</td>
              <td class="border border-gray-300 p-2">১টি কমপ্লেক্স, ৫টি ক্লিনিক</td>
              <td class="border border-gray-300 p-2">স্বাস্থ্য ক্যাম্প</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">শিক্ষা</td>
              <td class="border border-gray-300 p-2">স্কুল ১৫০+, কলেজ ৫টি</td>
              <td class="border border-gray-300 p-2">ডিজিটাল ক্লাসরুম</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">কৃষি/বাজার</td>
              <td class="border border-gray-300 p-2">৮০% কৃষি, ৫টি বাজার</td>
              <td class="border border-gray-300 p-2">কৃষক সাবসিডি বাজার</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">চাকরি/ব্যবসা</td>
              <td class="border border-gray-300 p-2">বেকারত্ব ৪.৫%, ছোট ব্যবসা ২০%</td>
              <td class="border border-gray-300 p-2">ইয়ুথ এমপ্লয়মেন্ট স্কিম</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="community" class="tab-content">
        <table class="w-full border-collapse border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 p-2">ক্যাটাগরি</th>
              <th class="border border-gray-300 p-2">তথ্য</th>
              <th class="border border-gray-300 p-2">প্রচারণা টিপ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-gray-300 p-2">ইউনিয়ন চেয়ারম্যান</td>
              <td class="border border-gray-300 p-2">১৫ জন (বরকামতা – AL-সমর্থক)</td>
              <td class="border border-gray-300 p-2">AL-সমর্থকদের সাথে অ্যালায়েন্স</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">ধর্মীয় নেতা</td>
              <td class="border border-gray-300 p-2">ইমাম/মাদ্রাসা ~২০০, হিন্দু কমিটি</td>
              <td class="border border-gray-300 p-2">ইমামদের সাথে সমন্বয় মিটিং</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">যুব ক্লাব</td>
              <td class="border border-gray-300 p-2">~৫০টি (দেবিদ্বার যুব সংঘ)</td>
              <td class="border border-gray-300 p-2">ক্লাবে যুবক-কেন্দ্রিক ইভেন্ট</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">ব্যবসায়ী/কন্ট্রাক্টর</td>
              <td class="border border-gray-300 p-2">~১০০ জন (কৃষি-ভিত্তিক)</td>
              <td class="border border-gray-300 p-2">অর্থনৈতিক উন্নয়ন মিটিং</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">মহিলা গ্রুপ/NGO</td>
              <td class="border border-gray-300 p-2">~২০টি (দেবিদ্বার মহিলা সংস্থা)</td>
              <td class="border border-gray-300 p-2">NGO-এর সাথে মহিলা ক্যাম্প</td>
            </tr>
            <tr>
              <td class="border border-gray-300 p-2">সোশ্যাল মিডিয়া/সাংবাদিক</td>
              <td class="border border-gray-300 p-2">Debidwar Citizen গ্রুপ ৫,০০০+ মেম্বার</td>
              <td class="border border-gray-300 p-2">গ্রুপে অ্যাডস, PR সাংবাদিকদের সাথে</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- পপআপ -->
    <div id="overlay" class="overlay" onclick="closePopup()"></div>
    <div id="popup" class="popup">
      <h3 id="popupTitle" class="text-xl font-bold mb-3"></h3>
      <p id="popupMessage" class="text-gray-700"></p>
      <button onclick="closePopup()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">বন্ধ করুন</button>
    </div>
  </div>

  <script>
    // ট্যাব ফাংশন
    function openTab(tabName) {
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');

      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => button.classList.remove('active'));
      event.target.classList.add('active');
    }

    // === সম্পূর্ণ ১৫ ইউনিয়নের ডেটা (আপডেটেড) ===
    const data = {
      debidwar: {
        unions: {
          'বরকামতা': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 25, '২৬–৩৫': 22, '৩৬–৫০': 25, '৫১+': 28}, religion: {muslim: 95, hindu: 5, other: 0}, voters: 24000, coords: [23.65, 91.05] },
          'বড়শালঘর': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 26, '২৬–৩৫': 21, '৩৬–৫০': 24, '৫১+': 29}, religion: {muslim: 96, hindu: 4, other: 0}, voters: 23000, coords: [23.64, 91.04] },
          'দক্ষিণ গুনাইঘর': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 24, '২৬–৩৫': 23, '৩৬–৫০': 26, '৫১+': 27}, religion: {muslim: 97, hindu: 3, other: 0}, voters: 22000, coords: [23.63, 91.03] },
          'ধামতী': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 27, '২৬–৩৫': 20, '৩৬–৫০': 25, '৫১+': 28}, religion: {muslim: 98, hindu: 2, other: 0}, voters: 25000, coords: [23.62, 91.02] },
          'এলাহাবাদ': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 25, '২৬–৩৫': 22, '৩৬–৫০': 24, '৫১+': 29}, religion: {muslim: 94, hindu: 6, other: 0}, voters: 21000, coords: [23.61, 91.01] },
          'ফতেহাবাদ': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 26, '২৬–৩৫': 21, '৩৬–৫০': 25, '৫১+': 28}, religion: {muslim: 96, hindu: 4, other: 0}, voters: 24000, coords: [23.60, 91.00] },
          'জাফরগঞ্জ': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 24, '২৬–৩৫': 23, '৩৬–৫০': 26, '৫১+': 27}, religion: {muslim: 97, hindu: 3, other: 0}, voters: 23000, coords: [23.59, 90.99] },
          'মোহনপুর': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 27, '২৬–৩৫': 20, '৩৬–৫০': 25, '৫১+': 28}, religion: {muslim: 98, hindu: 2, other: 0}, voters: 26000, coords: [23.58, 90.98] },
          'রাজামেহের': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 25, '২৬–৩৫': 22, '৩৬–৫০': 24, '৫১+': 29}, religion: {muslim: 94, hindu: 6, other: 0}, voters: 22000, coords: [23.57, 90.97] },
          'রসুলপুর': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 26, '২৬–৩৫': 21, '৩৬–৫০': 25, '৫১+': 28}, religion: {muslim: 96, hindu: 4, other: 0}, voters: 24000, coords: [23.56, 90.96] },
          'সুবিল': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 24, '২৬–৩৫': 23, '৩৬–৫০': 26, '৫১+': 27}, religion: {muslim: 97, hindu: 3, other: 0}, voters: 23000, coords: [23.55, 90.95] },
          'সুলতানপুর': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 27, '২৬–৩৫': 20, '৩৬–৫০': 25, '৫১+': 28}, religion: {muslim: 98, hindu: 2, other: 0}, voters: 25000, coords: [23.54, 90.94] },
          'উত্তর গুনাইঘর': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 25, '২৬–৩৫': 22, '৩৬–৫০': 24, '৫১+': 29}, religion: {muslim: 94, hindu: 6, other: 0}, voters: 21000, coords: [23.53, 90.93] },
          'ভানী': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 26, '২৬–৩৫': 21, '৩৬–৫০': 25, '৫১+': 28}, religion: {muslim: 96, hindu: 4, other: 0}, voters: 24000, coords: [23.52, 90.92] },
          'ইউসুফপুর': { gender: {male: 46, female: 54}, age: {'১৮–২৫': 24, '২৬–৩৫': 23, '৩৬–৫০': 26, '৫১+': 27}, religion: {muslim: 97, hindu: 3, other: 0}, voters: 23000, coords: [23.51, 90.91] }
        }
      }
    };

    let current = 'debidwar';
    let currentUnion = '';
    const charts = {};
    let map = null;
    let markers = null;

    function initMap() {
      if (map) return;
      map = L.map('map').setView([23.60, 90.99], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      markers = L.layerGroup().addTo(map);
    }

    function addMarkers() {
      if (!map || !markers) return;
      markers.clearLayers();
      const upazilaData = data[current];
      Object.keys(upazilaData.unions).forEach(unionName => {
        const union = upazilaData.unions[unionName];
        if (union.coords) {
          const marker = L.marker(union.coords).addTo(markers);
          const youth = Object.values(union.age).slice(0,2).reduce((a,b) => a+b, 0);
          const popupContent = `
            <b>${unionName}</b><br>
            ভোটার: ${union.voters.toLocaleString()}<br>
            যুবক (১৮-৩৫): ${youth}%<br>
            হিন্দু: ${union.religion.hindu}%<br>
            <button onclick="selectUnionFromMap('${unionName}')" style="background:#10b981;color:white;padding:4px 8px;border:none;border-radius:4px;margin-top:5px;font-size:12px;">চার্ট দেখুন</button>
          `;
          marker.bindPopup(popupContent);
        }
      });
      map.setView([23.60, 90.99], 12);
    }

    function selectUnionFromMap(unionName) {
      document.getElementById('unionFilter').value = unionName;
      currentUnion = unionName;
      updateCharts();
      closePopup();
    }

    function updateUnionFilter() {
      current = document.getElementById('upazilaFilter').value;
      const unionSelect = document.getElementById('unionFilter');
      unionSelect.innerHTML = '<option value="">সকল ইউনিয়ন (১৫টি)</option>';
      const unions = Object.keys(data[current].unions).sort();
      unions.forEach(union => {
        const option = document.createElement('option');
        option.value = union;
        option.textContent = union;
        unionSelect.appendChild(option);
      });
      currentUnion = '';
      updateCharts();
      addMarkers();
    }

    function updateCharts() {
      currentUnion = document.getElementById('unionFilter').value;
      const d = currentUnion ? data[current].unions[currentUnion] : averageData(current);

      if (charts.gender) charts.gender.destroy();
      charts.gender = new Chart(document.getElementById('genderChart'), {
        type: 'pie',
        data: { labels: ['পুরুষ', 'মহিলা'], datasets: [{ data: [d.gender.male, d.gender.female], backgroundColor: ['#2563eb', '#ec4899'] }] },
        options: { responsive: true, plugins: { title: { display: true, text: `${currentUnion || current} লিঙ্গ অনুপাত` } } }
      });

      if (charts.age) charts.age.destroy();
      charts.age = new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: { labels: Object.keys(d.age), datasets: [{ label: 'ভোটার (%)', data: Object.values(d.age), backgroundColor: '#10b981' }] },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: 'বয়স গ্রুপ' } },
          onClick: (e, el) => {
            if (el[0]) {
              const idx = el[0].index;
              const slogans = ["TikTok চ্যালেঞ্জ: #YouthCumilla", "স্কিল ট্রেনিং ক্যাম্প", "কৃষি সেমিনার", "পেনশন মেলা"];
              showPopup("ক্যাম্পেইন আইডিয়া", `${currentUnion}: ${slogans[idx]}`);
            }
          }
        }
      });

      if (charts.religion) charts.religion.destroy();
      charts.religion = new Chart(document.getElementById('religionChart'), {
        type: 'doughnut',
        data: { labels: ['মুসলিম', 'হিন্দু', 'অন্যান্য'], datasets: [{ data: [d.religion.muslim, d.religion.hindu, d.religion.other], backgroundColor: ['#22c55e', '#f97316', '#6b7280'] }] },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: 'ধর্মীয় গঠন' } }
        }
      });

      // শিক্ষা চার্ট
      if (charts.education) charts.education.destroy();
      charts.education = new Chart(document.getElementById('educationChart'), {
        type: 'pie',
        data: { labels: ['অশিক্ষিত', 'প্রাথমিক', 'মাধ্যমিক', 'উচ্চশিক্ষা'], datasets: [{ data: [49, 30, 15, 6], backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56'] }] },
        options: { responsive: true, plugins: { title: { display: false } } }
      });

      // পেশা চার্ট
      if (charts.occupation) charts.occupation.destroy();
      charts.occupation = new Chart(document.getElementById('occupationChart'), {
        type: 'bar',
        data: { labels: ['কৃষি', 'ব্যবসা', 'চাকরি', 'অন্যান্য'], datasets: [{ label: 'পেশা (%)', data: [70, 15, 10, 5], backgroundColor: '#f97316' }] },
        options: { responsive: true, plugins: { title: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      // ভোটার টার্নআউট চার্ট
      if (charts.turnout) charts.turnout.destroy();
      charts.turnout = new Chart(document.getElementById('turnoutChart'), {
        type: 'line',
        data: { labels: ['২০১৮', '২০২৪'], datasets: [{ label: 'টার্নআউট (%)', data: [80.2, 40], borderColor: '#ef4444', fill: false }] },
        options: { responsive: true, plugins: { title: { display: false } } }
      });

      if (currentUnion && data[current].unions[currentUnion].coords) {
        map.setView(data[current].unions[currentUnion].coords, 14);
      }
    }

    function averageData(upazila) {
      const unions = data[upazila].unions;
      const num = Object.keys(unions).length;
      const avg = { gender: {male: 0, female: 0}, age: {}, religion: {muslim: 0, hindu: 0, other: 0}, voters: 0 };
      Object.values(unions).forEach(u => {
        avg.gender.male += u.gender.male;
        avg.gender.female += u.gender.female;
        Object.keys(u.age).forEach(k => { if (!avg.age[k]) avg.age[k] = 0; avg.age[k] += u.age[k]; });
        avg.religion.muslim += u.religion.muslim;
        avg.religion.hindu += u.religion.hindu;
        avg.religion.other += u.religion.other;
        avg.voters += u.voters;
      });
      avg.gender.male /= num; avg.gender.female /= num;
      Object.keys(avg.age).forEach(k => avg.age[k] /= num);
      avg.religion.muslim /= num; avg.religion.hindu /= num; avg.religion.other /= num;
      return avg;
    }

    function showPopup(title, message) {
      document.getElementById('popupTitle').textContent = title;
      document.getElementById('popupMessage').textContent = message;
      document.getElementById('popup').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }

    function closePopup() {
      document.getElementById('popup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const element = document.getElementById('dashboard');
      const mapElement = document.getElementById('map');
      const mapCanvas = await html2canvas(mapElement, { scale: 1 });
      const container = document.createElement('div');
      container.appendChild(element.cloneNode(true));
      const mapClone = mapCanvas.cloneNode(true);
      mapClone.style.width = '100%';
      container.appendChild(mapClone);
      document.body.appendChild(container);
      const canvas = await html2canvas(container, { scale: 2 });
      document.body.removeChild(container);
      const img = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      const width = pdf.internal.pageSize.getWidth();
      const height = (canvas.height * width) / canvas.width;
      pdf.addImage(img, 'PNG', 0, 0, width, height);
      pdf.save(`Cumilla4_${currentUnion || 'সকল'}_Report.pdf`);
    }

    document.getElementById('upazilaFilter').addEventListener('change', updateUnionFilter);
    document.getElementById('unionFilter').addEventListener('change', updateCharts);

    window.onload = function() {
      initMap();
      updateUnionFilter();
    };
  </script>
</body>
</html>